package test_utils

import (
	"math/big"
	"sync"

	"github.com/copperexchange/knox-primitives/pkg/core"
	"github.com/copperexchange/knox-primitives/pkg/core/integration/helper_types"
)

type SafePrimeMocker struct {
	C                int
	M                *sync.Mutex
	SafePrimes       []*big.Int
	GenSafePrimeOrig func(bits uint) (*big.Int, error)

	_ helper_types.Incomparable
}

func NewSafePrimeMocker() *SafePrimeMocker {
	safePrimes := []string{
		"149733070000889359164997341887269678492567622861548827848177789617798896087700527742666556487067625157018732398723044900592139676587091448614694062308644103773420349475308565006812414011316707222952117356995235898326513922014064245500261502284232700000239637996317210939288142346037260252922095221620774421719",
		"160548212529266656450835317723986995506354164489205011186170843747001922901256813988352004800527041024944769507321955141676903369018631477092458191740140868584534221336429302128529013668801317719382040639871912038003136500998766347837952705285436451843874633386048523474797955639004220981753903650550076731667",
		"149687294492532349724300193280433884888463445909451018996566318402292290529033031987564872846388615100925869759656474800525794087683853335423316001515113302062295913146828763698607452166869070862215875525940903561330265834091489818591611717733851720624111588108926441917210471989721387952076762788765100097683",
		"165972023069656725867918908490666201560580301431145921221267562653560745216097695849196023088214829466623168538826649578835488969773630710558807240962877733207676846284180966755828831643775350801507090479820470541739174578937190027564430170165998809514089441377938550146343054822400240029866263635027262901759",
		"152860706339571909527981599988174199488228449185512424526209694492675036085009883661783023884426937971076088872437409070025972107977351800050278992286028661404145301192109681255187589362484204709894238847084850133245963012177240435523667057124321502074628146934116639977160010112076308810644905076803182848087",
		"174951747804934253397979002414861105740680311339768172525861795290193307298920874007758482054132547416617858542887215207946220663897644513521796083143059000921455968596924393315191105645460560644858786990406675523837340639141356511948758969963322477973152927146440163238622128921683762438090046762355791550427",
		"155911813533930583078629078611431173902540522987100354453802222696348446206107821683062586664926013617201332315045844948199899346757166222234369203037696829830497330801856990529865383733223693856779110312235612247928505244391128007229548171438028639996057829916806471024105152746580185590567286593540030480479",
		"177423846578129211381663515741164125861441401833851563730460921683081470722096147531698888766966032482301041064533111932128835103525748407124136026976564524912960836721557759394575116995954062932444873528341798578788317681103007627056585441658741067068368214209088003168296353933998933920529223176514451634903",
		"148007847192645558157866024420952312755585778498249826049968800517280401645964941661662869723246848358227237061746266992752856568999047645988772641977606982554731299297416543121174215729178855608994759487159981257809600995403841143673864075866542545054560214058690579977206768031013309017350279260376678887419",
		"160248120601476599191802002035575572464500283258358467985713789979884503227146176882601919571939824266308287937766857451342627406879737543994084770186730460974717902638189584201429911761238267788410136263324704464684327759610082141681964394521770034267456653258206932200672511245432477177825962349945203313643",
		"167972976026405758961251636617197686160553485555237758852864580813002098281715933851729422920171680046264274345813762278146097835951567800742520815533883188003360081445508971133122012603793377547836070513913754976712044408474580995559350562700414600817392539299053596601253459243631919184974538407065491499059",
		"170848963001318511081469904552433363815144984323140514492718481438995170532324701539135123093811376229066555816626061674944598527734265268015979997359162548138436275896957558620129489699346869891520105635598096009836464555814621722429144777899301967058377957658203538741932514680321390126900199606264188677219",
		"171208539692013550867570870164753194793450364126279765389253049807447013291559588944207721729522731916566517965391729972580823192888490433490042851436926881992663138564509972869027750629641363705780483004060633472725587415515025783344522731941109433763250782538600496955923955637035022241566468782804395329607",
		"162730568959161949539545770869405044023483695310326010359008559049417711440282873105814142261149559400035735402568599849260872792166328356405568937649013973856388790805714614703506440032802853671319923583908421649748262149559665758043393037245459025285473562100153302742387876262944316988309783492986265363587",
		"175562674582790773766710878879942414531574504612579429063013484908548196646255749685104075922612674310077952532464887975578960356148757068918048765901462299979052271800777061398359311639015217756730795577322961823672436494246777769079500166098795344794144455569129706917111605354558966716152954451536740978203",
		"161210414050949319895892488297735645675393837353976356232193037991628029687692502694968575211071804400598396364311240224004659197544060973103809953034889063462396278999909258806308270290494854113637306623531117254123631901714552925313047846097533329187245907004860730386547055522319804383393240439342108956143",
		"147625411692118757692947346014424924500841397814902595183217856800528948679238672369924458194789829349165945205280866755636582511342280061874145842655522899072800985040177656633704159684199288429135930488542744601290583648119871164248162593883123190137300178853519839752350454946121523176269205158253892374419",
		"164431133045494793773443993679538928992008119486731004158706997061718339557473271212989123145217097339783279930657454166830666437749891831811895921921683584787721015306648814255756380469587898542847191762239511932638418488040569569314938055160820413210057639480197453436381487505815282796768419671800225209879",
		"151604497947899254870153859384390194025860206420420822849975120241355310622719579925684545288748970519757708997162989308499182525630318705928960293714938634078763853716406227175897979639409610434535006366506775857847559063971034767090073645565200530417711520189193032552914176528933214977712111465614292300223",
		"139126526498125782057909647309171168927313511275550027219734029713632151618201455746807669026110879529427589040896639622767590117948260875021609746968780892362202733080062908895024172084412332832276738078957357276455837383767548221548301858137899105433476048416031821258006497185566493422790868519387900068327",
		"136813220979857921794406962481558503157896614362479239186412233797033273551700229339501890763903634976973658760245671628607843722774216841492300063061278208881998619747966920134895656766800895447023550773111458935607325860333752951361978475077802420663075985215002011389273138570253280353380056160521197758779",
		"157768361344464481894164340822606209616454187051069283944364436656750556390856364369520346285521222722246531413610615136744884608724526810928772992060734892378229603608725213821560616279605959690574041789173012935142274881113019299590203114865591258388767971663441920138696383534080655210968310827912726655423",
		"165802335610645466356357351700617417836342314286201224733852356432330042887709626949874812265072310677711528089683499374846997659235567089714984898446056898736737399617813879132195628190948995580675582971536074987687730886094426804176692333376052810941445697776367815647862354564907178418496743747782809957299",
		"147177866141864090116922579564686832774791060569045095353010681641815427827339977247311791719262345826940649973556223874963916074079607856869767226516747903975112758244059685038823912143958445071451523771342207389801081893617036161258076052655566721120144972895366359692229273732738101943292421322711986835599",
		"163269565908349521150737846994999000948785500599307075271841668532367368198094859407193154742717521667076854779938494121894241208150573477402583558201456440608918288794911417323852201443653290742945891886890857759088136629835194713336294823879886844047261727165583267779598763161546657845369838448578890878519",
		"176309113936911195553758861046108848243572826091905335017766499950419983455800169042063843970924679205419483808903143566782896093162927051220075734091272167564224992744048401658037157478993015254499981669941696026373413870709305950035151087680245972955094351096448988701242581629540611412220973496617794661847",
		"169922193188266111775186389367721764956165905984215763553547829994579051958886770640382321064168903171262877062110745101370963809433496529308882378603430622782847276466223816376956971673186194228786581280306457738574830886890442403588213787407581072128759069911353026714218235097036055027834418673684780849947",
		"155690830916176049580555672126863181443833923863919445740713275912171728844160510837973622735581106768786723067664662118400433070727653517801163057099455793892877452679230885344942598538409774588929174003824794388788081803710704125193244289572318911296634011745452977426431633576301050159898756464843297771747",
		"154892478850670613811326930895580537917492128872053548301377259496572841424658003712428492239124791988365964487122543132474104422005339802312006772051502166419520293719510977662794764850318883169663275767195242972484392000326682394509584300828588100420672275599881649309459992244562484326275108763470229269419",
		"165078969816820422550246477388665068074936710260726539531649449567845310134691545958561214099148915859779598968313296794488967629643248454486550890521230228449732620620785284749887239951406178382468585018587106244990047405149004841753434713373868155063036078103624567630561751155634611961860834497004455717843",
		"143441085318436938652401713949852625684817762475402285786354184138477880321954258137292122544966673141157335749433743828196754806329344762281778918997150343409176959453417662345709714240931357026578270149685793636057084817222040020909680409799706515513362282822334476016866841566000391902027869376072911227379",
		"142849390524374431931322383251929960857651462821593981853683452668967152846204199732325594328403064871516551934818280022981337113224333659157669846689019070397012783249765826314168141322212914110262762381270898093714886319502499837436148410370184624296084194133809161386820671378931611470362103974336901908487",
	}

	safePrimesInt := make([]*big.Int, len(safePrimes))
	for i := range safePrimes {
		safePrimesInt[i], _ = new(big.Int).SetString(safePrimes[i], 10)
	}

	return &SafePrimeMocker{
		SafePrimes:       safePrimesInt,
		C:                0,
		M:                &sync.Mutex{},
		GenSafePrimeOrig: core.GenerateSafePrime,
	}
}

func (m *SafePrimeMocker) Mock() {
	mBound := m
	genSafePrimeOrig := func(bits uint) (*big.Int, error) {
		if bits == 1024 {
			mBound.M.Lock()
			defer mBound.M.Unlock()
			mBound.C = (mBound.C + 1) % len(mBound.SafePrimes)
			return mBound.SafePrimes[mBound.C], nil
		}
		return mBound.GenSafePrimeOrig(bits)
	}
	core.GenerateSafePrime = genSafePrimeOrig
}
