package softspoken

import (
	"github.com/copperexchange/crypto-primitives-go/pkg/core/curves"
	"github.com/copperexchange/crypto-primitives-go/pkg/ot/base/simplest"
)

const (
	// ------------------------ CONFIGURABLE PARAMETERS --------------------- //
	// Kappa (κ) is the computational security parameter in bits. Set |q| = κ
	// for a curve of prime order q. It is the size of the PRG seeds (the BaseOT
	// options) as well as the number of output elements per batch.
	Kappa = 256

	// L is the ratio between scalars generated by the OTextension
	// and the number of BaseOT seeds. Set to 1 for DKLS23.
	L = 1

	// Sigma (σ, or s) is the statistical security parameter. Eta%σ=0.
	// Sigma is the numbet of bits to consume/discard in the consistency check.
	Sigma = 128

	// ---------------------- NON-CONFIGURABLE PARAMETERS ------------------- //
	// KeyCount is the number of options to choose from in the BaseOT. Set to 2
	// for 1-out-of-2 OT.
	KeyCount = 2

	// Eta (η) is the batch size in bits used in the cOT functionality.
	Eta = L * Kappa

	// EtaPrime (η') is the bit-length of pseudorandom seed expansions.
	EtaPrime = Eta + Sigma

	// number of blocks of size Sigma in the output batch
	M = Eta / Sigma

	// Equivalents in Bytes
	KappaBytes    = Kappa >> 3    // KappaBytes (κ) is the computational security parameter in bytes
	EtaBytes      = Eta >> 3      // EtaBytes (η) is the batch size in bytes
	SigmaBytes    = Sigma >> 3    // SigmaBytes (σ) is the statistical security parameter in bytes
	EtaPrimeBytes = EtaPrime >> 3 // XiBytes (ξ) is the bit-length of PRG seed expansions in bytes
	MBytes        = M >> 3        // M Bytesis the number of blocks in the consistency check in bytes
)

type Receiver struct {
	// baseOtSendOptions (k^i_0, k^i_1) ∈ [2][κ][κ]bits are the options used while
	//  of playing the sender in a base OT protocol. They are inputs to COTe.
	baseOtSendOptions *simplest.SenderOutput

	// ExtPackChoices (x_i) ∈ [η]bits are the choice bits for the OTe.
	ExtPackChoices [EtaPrimeBytes]byte

	// ExtOptions (t^i) ∈ [2][κ][η]bits are expansions of BaseOT results using a PRG.
	ExtOptions [KeyCount][Kappa][EtaPrimeBytes]byte

	// OutCorrelations (z_B) ∈ [η]curve.Scalar are the output "correlations" (in the curve).
	OutCorrelations [Eta]curves.Scalar

	curve           *curves.Curve
	useDerandomize  bool
	useFiatShamir   bool
	uniqueSessionId [simplest.DigestSize]byte // store this between rounds
}

type Sender struct {
	// baseOtRecOutputs (Δ_i ∈ [κ]bits, k^i_{Δ_i} ∈ [κ][κ]bits) are the results
	// of playing the receiver in a base OT protocol. They are inputs of COTe.
	baseOtRecOutputs *simplest.ReceiverOutput

	// ExtChosenOpt (t^i_{Δ_i}) ∈ [κ][η]bits are the extended (via a PRG) baseOT deltaOpts.
	ExtChosenOpt [Kappa][EtaPrimeBytes]byte

	// ExtCorrelations (q_i) ∈ [κ][η]bits are the extended correlations, such that:
	//    q^i = Δ_i • x + t^i
	ExtCorrelations [Kappa][EtaPrimeBytes]byte

	// OutDeltaOpt (z_A) ∈ [η]curve.Scalar are the output "DeltaOpt" group elements.
	OutDeltaOpt [Eta]curves.Scalar

	// curve is the elliptic curve used in the protocol.
	curve          *curves.Curve
	useDerandomize bool
	useFiatShamir  bool
}

// NewCOtReceiver creates a `Receiver` instance for the SoftSpokenOT protocol.
// The `baseOtResults` are the results of playing the sender role in kappa baseOTs.
func NewCOtReceiver(baseOtResults *simplest.SenderOutput, curve *curves.Curve, useFiatShamir bool, useDerandomize bool) *Receiver {
	return &Receiver{
		useFiatShamir:     useFiatShamir,
		baseOtSendOptions: baseOtResults,
		curve:             curve,
		OutCorrelations:   *new([Eta]curves.Scalar),
	}
}

// NewCOtSender creates a `Sender` instance for the SoftSpokenOT protocol.
// The `baseOtResults` are the results of playing the receiver role in kappa baseOTs.
func NewCOtSender(baseOtResults *simplest.ReceiverOutput, curve *curves.Curve, useFiatShamir bool, useDerandomize bool) *Sender {
	return &Sender{
		useFiatShamir:    useFiatShamir,
		baseOtRecOutputs: baseOtResults,
		OutDeltaOpt:      *new([Eta]curves.Scalar),
		curve:            curve,
	}
}
