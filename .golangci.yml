version: "2"
run:
  build-tags:
   - nobignum
   - purego
  tests: true

issues:
  # Maximum issues count per one linter. Set to 0 to disable. Default is 50.
  max-issues-per-linter: 0
  # Maximum count of issues with the same text. Set to 0 to disable. Default is 3.
  max-same-issues: 0
  fix: false

formatters:
  enable:
    # Gci control golang package import order and make it always deterministic.
    - gci
    # Gofmt checks whether code was gofmt-ed. By default this tool runs with -s option to check for code simplification.
    - gofmt
  settings:
    gci:
      sections:
        - standard
        - default
        - prefix(github.com/bronlabs)
        - blank
        - dot
      custom-order: true
    gofmt:
      simplify: true
      rewrite-rules:
        - pattern: interface{}
          replacement: any
    gofumpt:
      extra-rules: true
  exclusions:
    generated: lax
    paths:
      - gen
      - testutils
      - thirdparty
      - third_party$
      - builtin$
      - examples$
linters:
  default: none
  enable:
    # Check for pass []any as any in variadic func(...any).
    - asasalint
    # Simple linter to check that your code does not contain non-ASCII identifiers
    - asciicheck
    # Checks for dangerous unicode character sequences.
    - bidichk
    # Copyloopvar is a linter detects places where loop variables are copied.
    - copyloopvar
    # Go linter that checks if package imports are in a list of acceptable
    # packages.
    - depguard
    # Checks assignments with too many blank identifiers (e.g. x, , , _, := f())
    - dogsled
    # Tool for code clone detection
    - dupl
    # Checks for duplicate words in the source code.
    - dupword
    # Embedded types should be at the top of the field list of a struct, and there must be an empty line separating embedded fields from regular fields.
    - embeddedstructfieldcheck
    # Golang linter to check the errors handling expressions
    - err113
    # Errcheck is a program for checking for unchecked errors in go programs. These unchecked errors can be critical bugs in some cases
    - errcheck
    # Checks that sentinel errors are prefixed with the Err and error types are suffixed with the Error.
    - errname
    # errorlint is a linter for that can be used to find code that will cause problems with the error wrapping scheme introduced in Go 1.13.
    - errorlint
    # check exhaustiveness of enum switch statements
    - exhaustive
    # Checks if all structure fields are initialized.
    - exhaustruct
    # Detects functions from golang.org/x/exp/ that can be replaced by std functions.
    - exptostd
    # Forbids identifiers
    - forbidigo
    # Checks that go compiler directive comments (//go:) are valid.
    - gocheckcompilerdirectives
    # Checks that no init functions are present in Go code
    - gochecknoinits
    # Run exhaustiveness checks on Go "sum types".
    - gochecksumtype
    # Finds repeated strings that could be replaced by a constant
    - goconst
    # Provides many diagnostics that check for bugs, performance and style issues. Extensible without recompilation through dynamic rules. Dynamic rules are written declaratively with AST patterns, filters, report message and optional suggestion.
    - gocritic
    # Check if comments end in a period
    - godot
    # Manage the use of 'replace', 'retract', and 'excludes' directives in go.mod.
    - gomoddirectives
    # Checks that printf-like functions are named with f at the end
    - goprintffuncname
    # Inspects source code for security problems
    - gosec
    # Report certain i18n/l10n anti-patterns in your Go codebase.
    - gosmopolitan
    # Reports wrong mirror patterns of bytes/strings usage.
    - mirror
    # Vet examines Go source code and reports suspicious constructs, such as Printf calls whose arguments do not align with the format string
    - govet
    # Enforces consistent import aliases
    - importas
    # Intrange is a linter to find places where for loops could make use of an integer range.
    - intrange
    # Detects when assignments to existing variables are not used
    - ineffassign
    # Finds slice declarations with non-zero initial length
    - makezero
    # Finds commonly misspelled English words in comments
    - misspell
    # Finds naked returns in functions greater than a specified function length
    - nakedret
    # Finds the code that returns nil even if it checks that the error is not nil.
    - nilerr
    # Reports ill-formed or insufficient nolint directives
    - nolintlint
    # Checks that there is no simultaneous return of nil error and an invalid value.
    - nilnil
    # Paralleltest detects missing usage of t.Parallel() method in your Go test.
    - paralleltest
    # Finds slice declarations that could potentially be preallocated
    - prealloc
    # find code that shadows one of Go's predeclared identifiers
    - predeclared
    # Check that struct tags are well aligned.
    - tagalign
    # # # Checks the struct tags.
    # # TODO: enable this once it doesn't spit out ast errors
    # # - tagliatelle
    # Linter checks if examples are testable (have an expected output).
    - testableexamples
    # Checks usage of github.com/stretchr/testify.
    - testifylint
    # Fast, configurable, extensible, flexible, and beautiful linter for Go. Drop-in replacement of golint.
    - revive
    # # Staticcheck is a go vet on steroids, applying a ton of static analysis checks
    # - staticcheck
    # linter that makes you use a separate _test package
    - testpackage
    # thelper detects golang test helpers without t.Helper() call and checks the consistency of test helpers
    - thelper
    # Remove unnecessary type conversions
    - unconvert
    # Reports unused function parameters
    - unparam
    # A linter that detect the possibility to use variables/constants from the Go standard library.
    - usestdlibvars
    # Checks Go code for unused constants, variables, functions and types
    - unused
    # wastedassign finds wasted assignment statements.
    - wastedassign
    # Tool for detection of leading and trailing whitespace
    - whitespace
    # Checks that errors returned from external packages are wrapped
    - wrapcheck

  settings:
    asasalint:
      # To specify a set of function names to exclude.
      # The values are merged with the builtin exclusions.
      # The builtin exclusions can be disabled by setting `use-builtin-exclusions` to `false`.
      # Default: ["^(fmt|log|logger|t|)\.(Print|Fprint|Sprint|Fatal|Panic|Error|Warn|Warning|Info|Debug|Log)(|f|ln)$"]
      exclude:
        - \.Wrapf
      # To enable/disable the asasalint builtin exclusions of function names.
      # See the default value of `exclude` to get the builtin exclusions.
      use-builtin-exclusions: false
    depguard:
      rules:
        main:
          deny:
            - pkg: github.com/pkg/errors
              desc: Use custom error types from the errs package
    exhaustruct:
      # List of regular expressions to match type names that should be processed.
      # Anonymous structs can be matched by '<anonymous>' alias.
      #
      # Each regular expression must match the full type name, including package path.
      # For example, to match type `net/http.Cookie` regular expression should be `.*/http\.Cookie`,
      # but not `http\.Cookie`.
      # Default: []
      include: []
      # List of regular expressions to match type names that should be excluded from processing.
      # Anonymous structs can be matched by '<anonymous>' alias.
      # Has precedence over `include`.
      # Each regular expression must match the full type name, including package path.
      # For example, to match type `net/http.Cookie` regular expression should be `.*/http\.Cookie`,
      # but not `http\.Cookie`.
      # Default: []
      exclude:
        - '.+\.Test'
        - 'example\.com/package\.ExampleStruct[\d]{1,2}'
      # Allows empty structures, effectively excluding them from the check.
      # Default: false
      allow-empty: false
      # List of regular expressions to match type names that should be allowed to be empty.
      # Anonymous structs can be matched by '<anonymous>' alias.
      # Each regular expression must match the full type name, including package path.
      # For example, to match type `net/http.Cookie` regular expression should be `.*/http\.Cookie`,
      # but not `http\.Cookie`.
      # Default: []
      allow-empty-rx: []
      # Allows empty structures in return statements.
      # Default: false
      allow-empty-returns: true
      # Allows empty structures in variable declarations.
      # Default: false
      allow-empty-declarations: true
    dogsled:
      max-blank-identifiers: 3
    dupl:
      threshold: 175
    dupword:
      keywords:
        - the
        - and
        - a
    errcheck:
      check-type-assertions: true
      check-blank: false
      exclude-functions:
        - encoding/json.Marshal
        - encoding/json.MarshalIndent
    errchkjson:
      check-error-free-encoding: true
      report-no-exported: false
    errorlint:
      errorf: true
      errorf-multi: false
      asserts: true
      comparison: true
    exhaustive:
      check:
        - switch
        - map
      default-signifies-exhaustive: false
    forbidigo:
      forbid:
        - pattern: fmt\.Print.*
        - pattern: fmt\.Println.*
        - pattern: fmt\.Errorf.*
        - pattern: assert\.*
        - pattern: pubkey
        - pattern: Pubkey
        - pattern: PubKey
        - pattern: privkey
        - pattern: Privkey
    gochecksumtype:
      default-signifies-exhaustive: false
      include-shared-interfaces: false
    goconst:
      min-len: 3
      min-occurrences: 3
    gocritic:
      disable-all: true
      enabled-checks:
        - argOrder
        - badCall
        - badCond
        - badLock
        - badRegexp
        - badSorting
        - builtinShadowDecl
        - caseOrder
        - codegenComment
        - deferInLoop
        - deprecatedComment
        - dupArg
        - dupBranchBody
        - dupCase
        - dupSubExpr
        - dynamicFmtString
        - emptyDecl
        - evalOrder
        - exitAfterDefer
        - externalErrorReassign
        - filepathJoin
        - flagDeref
        - flagName
        - mapKey
        - nilValReturn
        - offBy1
        - regexpPattern
        - returnAfterHttpError
        - sloppyReassign
        - sloppyTypeAssert
        - sortSlice
        - sprintfQuotedString
        - sqlQuery
        - syncMapLoadAndDelete
        - truncateCmp
        - uncheckedInlineErr
        - unnecessaryDefer
        - weakCond
        - assignOp
        - boolExprSimplify
        - commentFormatting
        - commentedOutImport
        - defaultCaseOrder
        - deferUnlambda
        - docStub
        - dupImport
        - elseif
        - emptyFallthrough
        - emptyStringTest
        - exposedSyncMutex
        - hexLiteral
        - httpNoBody
        - ifElseChain
        - importShadow
        - initClause
        - methodExprCall
        - nestingReduce
        - newDeref
        - octalLiteral
        - paramTypeCombine
        - preferFilepathJoin
        - ptrToRefParam
        - redundantSprint
        - regexpMust
        - regexpSimplify
        - ruleguard
        - singleCaseSwitch
        - sloppyLen
        - stringConcatSimplify
        - stringsCompare
        - switchTrue
        - timeExprSimplify
        - todoCommentWithoutDetail
        - tooManyResultsChecker
        - typeAssertChain
        - typeDefFirst
        - typeSwitchVar
        - typeUnparen
        - underef
        - unlabelStmt
        - unlambda
        - unnamedResult
        - unnecessaryBlock
        - unslice
        - valSwap
        - whyNoLint
        - wrapperFunc
        - yodaStyleExpr
        - appendCombine
        - equalFold
        - hugeParam
        - indexAlloc
        - preferDecodeRune
        - preferFprint
        - preferStringWriter
        - preferWriteByte
        - rangeExprCopy
        - rangeValCopy
        - sliceClear
        - stringXbytes
      settings:
        hugeParam:
          sizeThreshold: 80
        nestingReduce:
          bodyWidth: 5
        rangeExprCopy:
          sizeThreshold: 512
          skipTestFuncs: true
        rangeValCopy:
          sizeThreshold: 128
          skipTestFuncs: true
        truncateCmp:
          skipArchDependent: true
        underef:
          skipRecvDeref: false
    godot:
      scope: toplevel
      exclude:
        - ^ [=-_]+$
        - ^ [A-Za-z-_]+$
        - ^ [A-Za-z-_]+ [A-Za-z-_]+$
        - '[TODO|FIXME]:'
        - '[:]+'
      capital: false
    gomoddirectives:
      replace-local: false
      exclude-forbidden: false
      retract-allow-no-explanation: false
    gosec:
      excludes:
        - G115
      severity: medium
      confidence: low
      config:
        G101:
          entropy_threshold: "80.0"
          ignore_entropy: false
          pattern: (?i)example
          per_char_threshold: "3.0"
          truncate: "32"
        G104:
          fmt:
            - Fscanf
        G111:
          pattern: custom\.Dir\(\)
        G301: "0750"
        G302: "0600"
        G306: "0600"
        global:
          '#nosec': '#my-custom-nosec'
          audit: true
          nosec: true
          show-ignored: true
      concurrency: 12
    gosmopolitan:
      allow-time-local: false
      watch-for-scripts:
        - Devanagari
        - Han
        - Hangul
        - Hiragana
        - Katakana
    govet:
      disable:
        - fieldalignment
      enable-all: true
    importas:
      alias:
        - pkg: crypto/rand
          alias: crand
        - pkg: filippo.io/edwards25519
          alias: filippo
      no-unaliased: true
    misspell:
      locale: UK
      extra-words:
        - typo: quorom
          correction: quorum
        - typo: sharign
          correction: sharing
    paralleltest:
      ignore-missing: false
      ignore-missing-subtests: false
    prealloc:
      simple: true
      range-loops: true
      for-loops: true
    predeclared:
      qualified-name: true
    revive:
      rules:
        - name: context-keys-type
        - name: time-equal
        - name: time-naming
        - name: var-declaration
        - name: unexported-return
        - name: blank-imports
        - name: context-as-argument
        - name: dot-imports
        - name: error-return
        - name: error-strings
        - name: error-naming
        - name: exported
        - name: if-return
        - name: increment-decrement
        - name: package-comments
        - name: range
        - name: receiver-naming
        - name: empty-block
        - name: deep-exit
        - name: superfluous-else
        - name: get-return
        - name: modifies-parameter
        - name: optimize-operands-order
        - name: string-format
        - name: confusing-results
        - name: datarace
        - name: unreachable-code
        - name: unnecessary-stmt
        - name: struct-tag
        - name: atomic
        - name: modifies-value-receiver
        - name: constant-logical-expr
        - name: bool-literal-in-expr
        - name: redefines-builtin-id
        - name: range-val-in-closure
        - name: range-val-address
        - name: waitgroup-by-value
        - name: call-to-gc
        - name: duplicated-imports
        - name: import-shadowing
        - name: bare-return
        - name: unused-receiver
        - name: string-of-int
        - name: early-return
        - name: unconditional-recursion
        - name: identical-branches
        - name: defer
          arguments:
            - - call-chain
              - method-call
              - recover
              - return
    staticcheck:
      checks:
        - all
    # tagliatelle:
    #   case:
    #     rules:
    #       avro: snake
    #       bson: camel
    #       env: upperSnake
    #       envconfig: upperSnake
    #       json: camel
    #       mapstructure: kebab
    #       xml: camel
    #       yaml: camel
    #     use-field-name: false
    testifylint:
      enable-all: true
      disable:
        - compares
      suite-extra-assert-call:
        mode: require
    whitespace:
      multi-if: true
      multi-func: false
    wrapcheck:
      ignore-sigs:
        - errs.
      ignore-package-globs:
        - google.golang.org/grpc/status
  exclusions:
    # Mode of the generated files analysis.
    #
    # - `strict`: sources are excluded by strictly following the Go generated file convention.
    #    Source files that have lines matching only the following regular expression will be excluded: `^// Code generated .* DO NOT EDIT\.$`
    #    This line must appear before the first non-comment, non-blank text in the file.
    #    https://go.dev/s/generatedcode
    # - `lax`: sources are excluded if they contain lines like `autogenerated file`, `code generated`, `do not edit`, etc.
    # - `disable`: disable the generated files exclusion.
    #
    # Default: strict
    generated: strict
    # Log a warning if an exclusion rule is unused.
    # Default: false
    warn-unused: true
    # Predefined exclusion rules.
    # Default: []
    presets:
      - comments
      - std-error-handling
      - common-false-positives
      - legacy
    # Excluding configuration per-path, per-linter, per-text and per-source.
    rules:
      # Exclude some linters from running on tests files.
      - path: _test\.go
        linters:
          # We're disabling `goconst` in tests, because there are a lot of
          # repeated non-constant strings in the tests that we don't want to
          # change eg. `cosigner id` as the cosigner id etc.
          - goconst
          # We're only enabling `godot` for library and internal code to make documentation
          # generation and/or text-editor's job prettier.
          - godot
          # It's unnecessary to have a hard wrapping requirement for tests.
          - wrapcheck
          # It's unnecessary to enforce errors are not defined dynamically
          - err113
          # Ignore revive results for tests because there a lot of conflicting
          # suggestions eg. `var-naming` says we shouldn't use underscores in
          # function names but that's a common pattern that we use.
          - revive
          # In tests we disable the check that prevents assigning errors to _
          - errcheck
          # duplicate code detection tends to break the subtesting pattern that we use.
          - dupl
          - gocritic
          - dogsled
          - errorlint
          - asciicheck
          - decorder
          - depguard
          - forbidigo
          - forcetypeassert
          - gochecknoinits
          - gosec # mostly weak prng
          - nilnil
          - prealloc
          - whitespace
          - govet
          - unused
          - wastedassign
          - exhaustruct
          - predeclared
          - unconvert
      # - path: utils.go
      #   linters:
      #     # TODO: enable this when round based stuff is here
      #     - unparam
      - path: testutils/
        linters:
          - depguard
          - wrapcheck
          - dupl
          - forbidigo
          - forcetypeassert
          - err113
          - gosec # mostly weak prng
          - nilnil
          - prealloc
          - whitespace
          - govet
          - exhaustive
      - path: curves/
        linters:
          - errcheck
          - gocritic
          - forbidigo
          - forcetypeassert
          - err113
          - nakedret
          # TODO: ENABLE THIS
          - wrapcheck
          - dupl
      - path: signatures/bls/
        linters:
          # so many castings to pairing point would then need redundant checks.
          # fix when we move to actual algebraic interfaces
          - errcheck
          - forcetypeassert
      # linter thinks value is unused if we type cast the interface and panic if not ok
      - path: curves/
        text: "SA4006"
        linters:
          staticcheck
      # big portions of `aes` trigger duplicated code (encrypt vs devrypt, constants) and
      # unused constants (poly).
      - path: thirdparty/
        linters:
          - dupl
          - unused
          - intrange
      # a lot of false positives for cselect
      - path: curves/
        text: "nilness: nil dereference in field selection"
        linters:
          govet
      # contents of impl are not supposed to be used by outside libraries, its constants
      - path: impl/
        text: "unexported-return"
        linters:
          - revive
      - path: impl/
        linters:
          - dupl
      - path: pkg/base/cgo
        linters:
          - gocritic
          - godot
      - path: pkg/encryption/hpke/internal
        linters:
          - dupl
          - exhaustruct
      # Exclude some revive messages
      - linters:
          - revive
        text: "var-naming: don't use ALL_CAPS in Go names; use CamelCase"
      # We don't want to check whether statements like `x, err := ...` shadows `err`
      - linters:
          - govet
        text: 'shadow: declaration of "err" shadows declaration at line'
      - linters:
          - govet
        text: 'shadow: declaration of "ok" shadows declaration at line'
      - linters:
          - gocritic
        text: "captLocal: `G1' should not be capitalized"
      - linters:
          - gocritic
        text: "captLocal: `G2' should not be capitalized"
      - linters:
          - gocritic
        text: "captLocal: `Gt' should not be capitalized"
      - linters:
          - staticcheck
        text: "ST1003: should not use underscores in package names"
      - path: ot/
        text: "captLocal"
        linters:
          - gocritic
      - path: cbor.go
        linters:
          - gochecknoinits
          - wrapcheck
      - path: key_agreement/
        text: "captLocal"
        linters:
          - gocritic
      - path: encryptions/
        text: "captLocal: `AD' should not be capitalized"
        linters:
          - gocritic
      - path: hpke/
        text: "captLocal: `L' should not be capitalized"
        linters:
          - gocritic
      # Exclude algebra package from wrapcheck - lots of interface method calls
      - path: pkg/base/algebra/
        linters:
          - wrapcheck
      # this has a collision with wrapcheck. We care about wrapcheck more, but
      # errchkjson is also important because it reports unsafe marshaling
      - linters:
          - errchkjson
        text: 'Error return value of `encoding/json.Marshal` is checked but passed argument is safe'

